version: '2'

services:
    app:
      image: mamelara/labkey-app:v1 # Uses my image but should use a JGI image
      ports:
        - "60044:8080"
      links:
        - "db:database"
      cap_drop:
        - ALL
      labels:
          io.rancher.container.pull_image: always
    db:
        # versions 9.6 and 9 are also available
        image: postgres:10
        ports:
          - "60045:5432/tcp"

        stdin_open: true
        tty: true

        volumes:
            - db.postgres.labkey:/var/lib/postgresql/data
        environment:
            POSTGRES_USER: PostgresUser
            POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
            TZ: US/Pacific

        cap_drop:
            - ALL
        cap_add:
            - CHOWN
            - DAC_OVERRIDE
            - FOWNER
            - SETGID
            - SETUID
        labels:
            # prevent running stale (cached) image on restart or upgrade
            io.rancher.container.pull_image: always
        secrets:
            - mode: '0444'
              uid: '0'
              gid: '0'
              source: db.postgres.postgres_password
              target: postgres_password
# note: secrets and volumes must have been created manually
volumes:
    db.postgres.labkey:
        driver: rancher-nfs
        external: true
secrets:
    db.postgres.postgres_password:
        external: true
